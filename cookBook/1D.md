# Разбор скрипта 1D (версия 1.8.2)

[Скрипт 1D](./scripts/core_1D_1.8.2.js) и [пример](./scripts/1D_hard.js) его настроек.

Скрипт `1D` добавляет элементы на пересечении измерений в справочник иерархий. Главной причиной использования иерархичных справочников является экономия дискового пространства. Скрипт выстраивает иерархическую зависимость между справочниками, тем самым избавляясь от обильного количества пустых ячеек в мультикубах. 

Описание настроек `ENV` на примере данных для конкретной модели:

```js
const ENV = {
	CORE: "core_1D_1.8.2",

	SOURCE_INFO: {
		MULTICUBE_NAME: "1D_Hard", // Наименование мультикуба, где мы определяем иерархию, согласно которой скрипт добавит элементы
		VIEW_NAME: null, // Представление, если необходимо
		INTERSECTION_CUBE_NAME: "Есть данные", // Наименование куба в формате BOOLEAN в MULTICUBE_NAME. Здесь хранятся пересечения справочников
		RELATION_CUBE_NAME: "ЦФО - PL.СтатьяЗатрат", // Наименование куба в MULTICUBE_NAME в формате итогового справочника. Заполняется скриптом. Необязательное поле
		DIMENSION_MAP: [
				{
					DIMENSION_NAME: "ЦФО" // Наименование одного из измерений MULTICUBE_NAME, которое используется для построения 1D, в порядке от верхнего уровня к нижнему (первый уровень)
				},
				{
					DIMENSION_NAME: "PL.СтатьяЗатрат", // Наименование одного из измерений MULTICUBE_NAME, которое используем для построения 1D, в порядке от верхнего уровня к нижнему (следующие 4 уровня)
					PARENT_STAIR: { // В этом блоке определяется, сколько родительски ступеней брать из справочника DIMENSION_NAME
						LIST_NAME: "PL.СтатьяЗатрат",
						VIEW_NAME: null, // Представление, если необходимо
						LEVELS: [0, 1, 2], // Позволяет указать, какие уровни справочника LIST_NAME нужно брать в 1D, 0 - брать первый уровень, предшествующий справочнику LIST_NAME, 1 - второй уровень, и т. д. В данном случае берётся 4 уровня: PL.СтатьяЗатрат, PL.Родитель.6, PL.Родитель.3, PL.GR
					}
				}
			]
	},

	DESTINATION_INFO: {
		DIMENSION_MAP: [
			{
				LIST_NAME: "ЦФО", // Наименование родительского справочника. Первую ступень в иерархии не заполняем
				VIEW_NAME: null, // Представление, если необходимо
				ID_COLUMNS: [
					"p.ЦФО" // Наименование свойства этого справочника, который хранит элемент справочника (Можно получить через ITEM() )
				],
				CAN_MANAGE: false, // Будут ли вноситься изменения в справочник (создаваться элементы)	
				DIMENSION_COLUMN: null, // Свойство, в котором скрипт проставит созданные элементы. Если CAN_MANAGE === false, указывать необязательно
				STATUS_COLUMN: null, // Свойство формата BOOLEAN, в котором скрипт будет заполнять статус в справочнике. В итоге должна получиться выборка из актуальных элементов. Указывать необязательно
			},
			{
				LIST_NAME: "ЦФО - GR", // Наименование 1D справочника, в который будем вносить элементы скриптом
				VIEW_NAME: null,
				ID_COLUMNS: [
					"p.ЦФО",	// Наименование свойства, в котором храним элементы родительского справочника
					"p.PL.GR" // Наименование свойства, в которое скрипт будет вносить элементы исходного справочника
				],
				CAN_MANAGE: true,
				ADD_TO_START: false, // По умолчанию скрипт добавляет новые созданные элементы в конец, настройка позволяет добавлять элемент в начало. По факту элемент так же добавляется вниз, но потом перемещается скриптом => время выполнения скрипта ЗНАЧИТЕЛЬНО увеличивается. Параметр можно устанавливать на каждом уровне, где добавляются элементы 
				DIMENSION_COLUMN: "p.PL.GR",
				STATUS_COLUMN: null,
			},
			{
				LIST_NAME: "ЦФО - Родитель3",
				VIEW_NAME: null,
				ID_COLUMNS: [
					"p.ЦФО",
					"p.PL.GR",
					"p.PL.Родитель.3"
				],
				CAN_MANAGE: true,
				ADD_TO_START: false,
				DIMENSION_COLUMN: "p.PL.Родитель.3",
				STATUS_COLUMN: null,
			},
			{
				LIST_NAME: "ЦФО - Родитель6",
				VIEW_NAME: null,
				ID_COLUMNS: [
					"p.ЦФО",
					"p.PL.GR",
					"p.PL.Родитель.3",
					"p.PL.Родитель.6"
				],
				CAN_MANAGE: true,
				ADD_TO_START: false,
				DIMENSION_COLUMN: "p.PL.Родитель.6",
				STATUS_COLUMN: null,
			},
			{
				LIST_NAME: "ЦФО - СЗ",
				VIEW_NAME: null,
				ID_COLUMNS: [
					"p.ЦФО",
					"p.PL.GR",
					"p.PL.Родитель.3",
					"p.PL.Родитель.6",
					"p.PL.СЗ"
				],
				CAN_MANAGE: true,
				ADD_TO_START: false,
				DIMENSION_COLUMN: "p.PL.СЗ",
				STATUS_COLUMN: "s.ЦФО - СЗ"
			}
		]
	}
};
```

Глобально действие скрипта состоит из 7 этапов, что отражено в основной вызываемой функции `Macros.load()`:

```js
load() {
	this.loadSourceTree();
	this.loadDestTree();
	this.connectDestToSourceTree();
	this.manageOldDestItems();
	this.manageExistDestItems();
	this.manageNewDestItems();
	this.updateSourceRelationColumn();
}
```

Рассмотрим эти этапы по отдельности.

## Загрузка дерева источника

## Загрузка дерева приёмника

## Соединение деревьев

## Управление старыми элементами приёмника

## Управление существующими элементами приёмника

## Управление новыми элементами приёмника

## Обновление куба отношения


[Курс молодого бойца](cookBook.md)

[Оглавление](../README.md)
